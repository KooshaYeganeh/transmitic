<html>

<head>
    <title>Shared With Me</title>
    <style>
        @import url(style.css);
    </style>
    <script src="global_transmitic.js"></script>
    <script>

        // TODO cache data to not require refresh and state time of collection
        // TODO Replace with proper components to remove random divID mapping
        // TODO Don't create HTML until expanded?
        class SharedData extends Element {

            owner
            inProgress
            files
            error

            this(props) {
                this.owner = props.owner;
                this.inProgress = props.in_progress;
                this.files = props.files;
                this.error = props.error;
            }

            render(props) {
                let content;
                let refreshButton = <button class="refresh-user" style="font-size: 8pt; margin-left: 1em; display: inline-block;">Refresh</button>

                if (this.inProgress) {
                    content = <div>Refreshing...</div>;
                }
                else {
                    content = this.createFileList(this.files, this.error, 0);
                }

                return <div>
                    <div>
                        <h3 style="display: inline-block;">{this.owner}</h3>
                        {refreshButton}
                    </div>
                    {content}
                </div>
            }

            createFileList(files, error, divID) {
                if (error) {
                    return <span>{error}<br /></span>;
                }
                if (!files) {
                    return "";
                }

                let style = "padding-left: 1.5em";
                let parentStyle = "display: none;";
                if (divID == 0) {
                    parentStyle = "";
                }
                return <div id={divID} style={parentStyle}>
                    {files.map((d) => <div style={style}>{this.createFile(d)}</div>)}
                </div>
            }

            createFile(d) {
                let showMore = "";
                let divID = 0;
                let info = "File";
                if (d.files.length > 0) {
                    info = "Folder (" + d.files.length + " total files)";
                    let childrenLength = d.files.length;
                    if (childrenLength > 2) {
                        divID = Math.random().toString();
                        divID = divID.substring(2, divID.length);
                        showMore = <button style="font-size: 8pt; margin-left: 1em;" class="show-more" div-id={divID} data-state="show" data-children={childrenLength}>Show more ({childrenLength})</button>;
                    }
                }
                return <div><button class="file-checkbox" data-path={d.path} data-owner={this.owner} type="checkbox">{d.path} | {info} | {d.size_string} </button> {showMore} <br /> {this.createFileList(d.files, "", divID)}</div>
            }

            ["on click at button.file-checkbox"](evt, btn) {
                document.$("button#download-selected").state.disabled = false;
            }

            ["on click at button.show-more"](evt, btn) {
                let divID = btn.getAttribute("div-id");

                let children = btn.getAttribute("data-children")
                if (btn.getAttribute("data-state") == "show") {
                    document.$("div#" + divID).style.display = "inline-block";
                    btn.setAttribute("data-state", "collapse");
                    btn.content("Collapse (" + children + ")");
                } else {
                    document.$("div#" + divID).style.display = "none";
                    btn.setAttribute("data-state", "show");
                    btn.content("Show more (" + children + ")");
                }

            }

            ["on click at button.refresh-user"](evt, btn) {
                let response = Window.this.xcall('start_refresh_shared_with_me_single_user', this.owner);
                this.componentUpdate({ inProgress: true });

                this.timer(500, () => {

                    let response = Window.this.xcall('get_shared_with_me_data');

                    let keepRefreshing = false;
                    let files = [];
                    let error;
                    for (const fileData of response) {
                        if (fileData.owner == this.owner) {
                            keepRefreshing = fileData.in_progress;
                            files = fileData.files;
                            error = fileData.error;
                        }
                    }

                    if (!keepRefreshing) {
                        this.componentUpdate({ inProgress: false, files: files, error: error, });
                    }

                    return keepRefreshing; // keep ticking
                });
            }

        }

        class SharedWithMe extends Element {

            refreshState;
            fileData;
            totalCount;
            finishedCount;

            this(props) {
                this.refreshState = "empty";
                this.fileData = Window.this.xcall('get_shared_with_me_data');
                this.totalCount = 0;
                this.finishedCount = 0;
            }

            render(props) {

                if (this.fileData.length == 0) {
                    return <div>Add a new user in the "Users" tab</div>;
                }

                let contentElements;
                if (this.refreshState === "empty") {
                    contentElements = <div>{this.fileData.map((d) => <div><hr style="margin-top: 2em;" /><SharedData owner={d.owner} files={d.files} error={d.error} inProgress={d.in_progress} /> </div>)} </div>;
                }
                else if (this.refreshState === "refreshing") {
                    contentElements = <div><br />Refreshing All...<br />{this.fileData.map((d) => <div><hr style="margin-top: 2em;" /><SharedData owner={d.owner} files={d.files} error={d.error} inProgress={d.in_progress} /></div>)} </div>;

                }
                else if (this.refreshState === "finished") {
                    contentElements = <div><br />Finished Refreshing<br />{this.fileData.map((d) => <div><hr style="margin-top: 2em;" /><SharedData owner={d.owner} files={d.files} error={d.error} inProgress={d.in_progress} /></div>)} </div>;
                }
                else {
                    contentElements = <div><br />Error: Unknown refreshState '{this.refreshState}'</div>;
                }
                let finalData = <div>
                    <button id="refresh-all">Refresh All</button>
                    <button style="margin-left: 1em;" id="download-selected" class="active-button">Download Selected</button>
                    {contentElements}
                </div>
                return finalData;
            }

            ["on click at button#download-selected"]() {
                let checkedBoxes = document.querySelectorAll("button[type=checkbox]:checked");
                let selectedFiles = [];
                for (const box of checkedBoxes) {
                    let path = box.getAttribute("data-path");
                    let owner = box.getAttribute("data-owner");
                    selectedFiles.push({ "path": path, "owner": owner });
                }

                let downloadCount = selectedFiles.length;
                if (downloadCount > 0) {
                    document.$("button#download-selected").state.disabled = true;
                    let response = Window.this.xcall('download_selected', { "files": selectedFiles });
                    setMsgBoxSuccess("<strong>" + downloadCount + "</strong> downloads started");
                    for (const box of checkedBoxes) {
                        box.checked = false;
                    }

                }

            }

            ["on click at button#refresh-all"]() {
                document.$("button#refresh-all").state.disabled = true; // TODO move into render
                document.$("button#download-selected").state.disabled = true; // TODO move into render
                let response = Window.this.xcall('start_refresh_shared_with_me_all');
                this.componentUpdate({ refreshState: "refreshing" });

                this.timer(500, () => {

                    let response = Window.this.xcall('get_shared_with_me_data');
                    this.componentUpdate({ fileData: response, refreshState: "refreshing" });

                    let keepRefreshing = false;
                    for (const fileData of response) {
                        if (fileData.in_progress) {
                            keepRefreshing = true;
                        }
                    }
                    if (!keepRefreshing) {
                        this.componentUpdate({ fileData: response, refreshState: "finished" });
                        document.$("button#refresh-all").state.disabled = false; // TODO move into render
                    }

                    return keepRefreshing; // keep ticking
                });
            }

        }

        document.ready = function () {
            eachPageReady();

            document.$("div#shared-with-me").content(<SharedWithMe />);
            let downloadButton = document.$("button#download-selected");
            if (downloadButton) {
                downloadButton.state.disabled = true;
            }
        }

    </script>
</head>

<body>
    <div class="main-body" style="size:*;">
        <!-- ^ sciter hack size-->
        <div id="msg-box"></div>

        <h1>
            Shared With Me
        </h1>

        <div id="shared-with-me" style="size:*;"></div><!-- sciter hack size-->
    </div>
</body>

</html>