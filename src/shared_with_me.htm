<html>

<head>
    <title>Shared With Me</title>
    <style>
        @import url(style.css);
    </style>
    <script src="global_transmitic.js"></script>
    <script>

        // TODO cache data to not require refresh and state time of collection
        // TODO Replace with proper components to remove random divID mapping
        // TODO Don't create HTML until expanded?
        class SharedData extends Element {

            owner

            this(props) {
                this.owner = props.owner;
            }

            render(props) {
                return <div>
                    <h3>{props.owner}</h3>
                    {this.createFileList(props.files, props.error, 0, 0)}
                </div>
            }

            createFileList(files, error, divID) {
                if (error) {
                    return error;
                }
                if (!files) {
                    return "";
                }

                let style = "padding-left: 1.5em";
                let parentStyle = "display: none;";
                if (divID == 0) {
                    parentStyle = "";
                }
                return <div id={divID} style={parentStyle}>
                    {files.map((d) => <div style={style}>{this.createFile(d)}</div>)}
                </div>
            }

            createFile(d) {
                let showMore = "";
                let divID = 0;
                let info = "File";
                if (d.files.length > 0) {
                    info = "Folder (" + d.files.length + " total files)";
                    let childrenLength = d.files.length;
                    if (childrenLength > 2) {
                        divID = Math.random().toString();
                        divID = divID.substring(2, divID.length);
                        showMore = <button style="font-size: 8pt; margin-left: 1em;" class="show-more" div-id={divID} data-state="show" data-children={childrenLength}>Show more ({childrenLength})</button>;
                    }
                }
                return <div><button data-path={d.path} data-owner={this.owner} type="checkbox">{d.path} | {info} | {d.size_string} </button> {showMore} <br /> {this.createFileList(d.files, "", divID)}</div>
            }

            ["on click at button.show-more"](evt, btn) {
                let divID = btn.getAttribute("div-id");

                let children = btn.getAttribute("data-children")
                if (btn.getAttribute("data-state") == "show") {
                    document.$("div#" + divID).style.display = "inline-block";
                    btn.setAttribute("data-state", "collapse");
                    btn.content("Collapse (" + children + ")");
                } else {
                    document.$("div#" + divID).style.display = "none";
                    btn.setAttribute("data-state", "show");
                    btn.content("Show more (" + children + ")");
                }

            }

        }

        class SharedWithMe extends Element {

            refreshState;
            fileData;
            totalCount;
            finishedCount;

            this(props) {
                this.refreshState = "empty";
                this.fileData = [];
                this.totalCount = 0;
                this.finishedCount = 0;
            }

            render(props) {
                let contentElements;
                if (this.refreshState === "empty") {
                    contentElements = <div><br />Press Refresh All to get files shared with you</div>;
                }
                else if (this.refreshState === "refreshing") {
                    contentElements = <div><br />Refreshing...{this.finishedCount}/{this.totalCount} complete</div>;
                }
                else if (this.refreshState === "finished") {
                    contentElements = <div>{this.fileData.map((d) => <div><SharedData owner={d.owner} files={d.files} error={d.error} /> <hr style="margin-top: 1em;" /></div>)} </div>;
                }
                else {
                    contentElements = <div><br />Error: Unknown refreshState '{this.refreshState}'</div>;
                }
                let finalData = <div>
                    <button id="refresh-all">Refresh All</button>
                    <button style="margin-left: 1em;" id="download-selected" class="active-button">Download Selected</button>
                    {contentElements}
                </div>
                return finalData;
            }

            ["on click at button#download-selected"]() {
                let checkedBoxes = document.querySelectorAll("button[type=checkbox]:checked");
                let selectedFiles = [];
                for (const box of checkedBoxes) {
                    let path = box.getAttribute("data-path");
                    let owner = box.getAttribute("data-owner");
                    selectedFiles.push({ "path": path, "owner": owner });
                }

                let downloadCount = selectedFiles.length;
                if (downloadCount > 0) {
                    let response = Window.this.xcall('download_selected', { "files": selectedFiles });
                    setMsgBoxSuccess("<strong>" + downloadCount + "</strong> downloads started");
                }

            }

            ["on click at button#refresh-all"]() {
                document.$("button#refresh-all").state.disabled = true; // TODO move into render
                document.$("button#download-selected").state.disabled = true; // TODO move into render
                let response = Window.this.xcall('start_refresh_shared_with_me');
                this.componentUpdate({ refreshState: "refreshing", totalCount: response, finishedCount: 0 });

                this.timer(500, () => {
                    let response = Window.this.xcall('get_refresh_state');
                    let inProgress = response[0];
                    let finishedCount = response[1];

                    if (inProgress) {
                        this.componentUpdate({ refreshState: "refreshing", finishedCount: finishedCount });
                        return true; // to keep the timer ticking
                    } else {
                        let response = Window.this.xcall('refresh_shared_with_me');
                        this.componentUpdate({ fileData: response, refreshState: "finished" });
                        document.$("button#refresh-all").state.disabled = false; // TODO move into render
                        document.$("button#download-selected").state.disabled = false; // TODO move into render
                        return false;
                    }
                });
            }

        }

        document.ready = function () {
            eachPageReady();

            document.$("div#shared-with-me").content(<SharedWithMe />);
            document.$("button#download-selected").state.disabled = true; // TODO move into render
        }

    </script>
</head>

<body>
    <div class="main-body">
        <div id="msg-box"></div>

        <h1>
            Shared With Me
        </h1>

        <div id="shared-with-me"></div>
    </div>
</body>

</html>